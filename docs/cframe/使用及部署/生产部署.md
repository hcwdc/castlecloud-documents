---
order: 3
group:
  order: 1
---

# æœåŠ¡å™¨éƒ¨ç½²

psï¼šä¸‹é¢æä¾›çš„æ˜¯åŸºäºå®å¡”å¯è§†åŒ–çš„é…ç½®æ•™ç¨‹

> æµ‹è¯•ç¯å¢ƒæµ‹è¯•ï¼šCentOS 7.x
>
> æ•°æ®åº“ï¼šMysql5.7+  
> ä¸­é—´ä»¶ï¼šNginx1.8.1ã€redis  
> JDK 1.8+ å®‰è£…æ•™ç¨‹ï¼šhttp://wiki.nooss.cn/archives/212.html

### #0x01 ä¸‹è½½ä»£ç 

```shell
# ä¸‹è½½å¹¶è¿è¡ŒæœåŠ¡ç«¯ä»£ç 
git clone

# ä¸‹è½½å¹¶è¿è¡Œå‰ç«¯UI
git clone
```

### #0x02 æ‰“åŒ…æ–‡ä»¶

#### å‰ç«¯ä¿®æ”¹

å‰ç«¯æ–‡ä»¶åœ¨æ ¹ç›®å½•ä¸‹æœ‰ä¸ª`vue.config.js`æ–‡ä»¶ï¼Œä¿®æ”¹ä¸‹é¢çš„è·¯å¾„

```java
publicPath: process.env.NODE_ENV === 'production' ? '/admin/' : '/',
```

> /admin/ è¯¥è·¯å¾„å¯¹åº”ä½ åæœŸæƒ³è®¿é—®çš„è·¯å¾„ï¼Œä¹Ÿæ˜¯æœåŠ¡å™¨çš„è·¯å¾„ï¼Œå¦‚æœç›´æ¥æ˜¯æ ¹åŸŸåè®¿é—®çš„è¯ï¼Œå¯ä»¥å°†è¯¥è·¯å¾„ç›´æ¥å†™ä¸º`/`

å‰ç«¯æ–‡ä»¶è¿˜éœ€è¦ä¿®æ”¹æœåŠ¡è®¿é—®è·¯å¾„`.env.development`å’Œ`.env.production` æˆ‘ä»¬å‘å¸ƒçº¿ä¸Šçš„è¯ï¼Œéœ€è¦ä¿®æ”¹`.env.production`æ–‡ä»¶

é…ç½®æ–‡ä»¶è¯´æ˜ï¼š

```yaml
NODE_ENV=production VUE_APP_NODE_ENV=prod VUE_APP_ISSTATIC=true VUE_APP_CODEROOT_URL_ENV=http://localhost:8082/ VUE_APP_ROOT_URL_ENV=https://localhost:8082
```

- ä»£ç ç”Ÿæˆå™¨åœ°å€ï¼šVUE_APP_CODEROOT_URL_ENV
- æœåŠ¡åœ°å€ï¼šVUE_APP_ROOT_URL_ENV

æ‰“åŒ…å‘½ä»¤

```shell
npm install
npm run build
```

#### åç«¯ä¿®æ”¹

```yaml
server:
  servlet:
    context-path: /
```

`application-prod.yml` æ–‡ä»¶å…¨éƒ¨é…ç½®ï¼Œè¯·å‚è€ƒæ³¨é‡Šè¿›è¡Œä¿®æ”¹

```yaml
# æœåŠ¡ç«¯å£
server:
  port: 8081

#ç³»ç»Ÿä¸ªæ€§åŒ–è®¾ç½®
castle:
  #å›¾å½¢éªŒè¯ç 
  imageCaptcha:
    #æ˜¯å¦å¼€å¯å›¾å½¢éªŒè¯ç  trueå¼€å¯ false å…³é—­
    isOpen: true
    #å›¾ç‰‡ç±»å‹ 1:æ•°å­—å­—æ¯éªŒè¯ç  2 å›¾å½¢æ‹–æ‹½éªŒè¯ç 
    imageType: 2
    #å›¾å‹éªŒè¯ç è·¯å¾„(å¦‚æœç±»å‹ä¸º2(æ‹–æ‹½)åˆ™è¯¥é…ç½®ç”Ÿæ•ˆ)
    #å›¾å‹éªŒè¯ç è·¯å¾„
    imagePath: /www/wwwroot/pretty.icuapi.com/image
  # é‚®ä»¶ä¸´æ—¶æ–‡ä»¶å­˜å‚¨ç›®å½•
  mailFilePath:
    mailFile: /www/wwwroot/pretty.icuapi.com/temp/
  #cmsç›¸å…³é…ç½®
  cms:
    #æ¨¡æ¿è·¯å¾„ä»¥æ–‡ä»¶åˆ†éš”ç¬¦ç»“æŸ
    templatePath: /www/wwwroot/pretty.icuapi.com/cmsTemplates/

spring:
  datasource:
    # ä½¿ç”¨é˜¿é‡Œçš„Druidè¿æ¥æ± 
    type: com.alibaba.druid.pool.DruidDataSource
    driver-class-name: com.mysql.jdbc.Driver
    # å¡«å†™ä½ æ•°æ®åº“çš„urlã€ç™»å½•åã€å¯†ç å’Œæ•°æ®åº“å
    #    url: jdbc:mysql://47.104.183.57:3306/china_gold?useUnicode=true&characterEncoding=UTF-8&serverTimezone=Asia/Shanghai
    #    username: root
    #    password: 9740a6b7fecc4a6d
    url: jdbc:mysql://localhost:3306/newcastle?useUnicode=true&characterEncoding=UTF-8&serverTimezone=Asia/Shanghai
    username: newcastle
    password: 8GH6AMzPHhmipbbS
    druid:
      # è¿æ¥æ± çš„é…ç½®ä¿¡æ¯
      # åˆå§‹åŒ–å¤§å°ï¼Œæœ€å°ï¼Œæœ€å¤§
      initial-size: 5
      min-idle: 5
      maxActive: 20
      # é…ç½®è·å–è¿æ¥ç­‰å¾…è¶…æ—¶çš„æ—¶é—´
      maxWait: 60000
      # é…ç½®é—´éš”å¤šä¹…æ‰è¿›è¡Œä¸€æ¬¡æ£€æµ‹ï¼Œæ£€æµ‹éœ€è¦å…³é—­çš„ç©ºé—²è¿æ¥ï¼Œå•ä½æ˜¯æ¯«ç§’
      timeBetweenEvictionRunsMillis: 60000
      # é…ç½®ä¸€ä¸ªè¿æ¥åœ¨æ± ä¸­æœ€å°ç”Ÿå­˜çš„æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’
      minEvictableIdleTimeMillis: 300000
      validationQuery: SELECT 1
      testWhileIdle: true
      testOnBorrow: false
      testOnReturn: false
      # æ‰“å¼€PSCacheï¼Œå¹¶ä¸”æŒ‡å®šæ¯ä¸ªè¿æ¥ä¸ŠPSCacheçš„å¤§å°
      poolPreparedStatements: true
      maxPoolPreparedStatementPerConnectionSize: 20
      # é…ç½®ç›‘æ§ç»Ÿè®¡æ‹¦æˆªçš„filtersï¼Œå»æ‰åç›‘æ§ç•Œé¢sqlæ— æ³•ç»Ÿè®¡ï¼Œ'wall'ç”¨äºé˜²ç«å¢™
      filters: stat,wall,slf4j
      # é€šè¿‡connectPropertieså±æ€§æ¥æ‰“å¼€mergeSqlåŠŸèƒ½ï¼›æ…¢SQLè®°å½•
      connectionProperties: druid.stat.mergeSql\=true;druid.stat.slowSqlMillis\=5000
      # é…ç½®DruidStatFilter
      web-stat-filter:
        enabled: true
        url-pattern: '/*'
        exclusions: '*.js,*.gif,*.jpg,*.bmp,*.png,*.css,*.ico,/druid/*'
      # é…ç½®DruidStatViewServlet
      stat-view-servlet:
        url-pattern: '/druid/*'
  redis:
    # Redisæ•°æ®åº“ç´¢å¼•ï¼ˆé»˜è®¤ä¸º0ï¼‰
    database: 1
    # RedisæœåŠ¡å™¨åœ°å€
    host: 127.0.0.1
    # RedisæœåŠ¡å™¨è¿æ¥ç«¯å£
    port: 6379
    # Rediså¯†ç 
    password: hcses.com # å¯†ç ï¼ˆé»˜è®¤ä¸ºç©ºï¼‰
    jedis:
      pool:
        # è¿æ¥æ± æœ€å¤§è¿æ¥æ•°ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰
        max-active: 8
        # è¿æ¥æ± æœ€å¤§é˜»å¡ç­‰å¾…æ—¶é—´ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰
        max-wait: -1
        # è¿æ¥æ± ä¸­çš„æœ€å¤§ç©ºé—²è¿æ¥
        max-idle: 8
        # è¿æ¥æ± ä¸­çš„æœ€å°ç©ºé—²è¿æ¥
        min-idle: 0
      # è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    timeout: 0
```

ä¿®æ”¹å®Œæˆä¹‹åï¼Œç›´æ¥ä½¿ç”¨æ‰“åŒ…å‘½ä»¤è¿›è¡Œæ‰“åŒ…å³å¯

```
mvn clean package
```

### #0x03 åˆ›å»ºç«™ç‚¹

![å®å¡”åˆ›å»ºç«™ç‚¹](https://oss.icuapi.com/docs/openapi/%E5%88%9B%E5%BB%BA%E7%AB%99%E7%82%B9.png)

åœ¨å®å¡”ç¯å¢ƒä¸‹ï¼Œç›´æ¥åˆ›å»ºç«™ç‚¹å³å¯ã€‚

åˆ›å»ºå¥½ç«™ç‚¹ä¹‹åï¼Œåœ¨ç½‘ç«™ç›®å½•ä¸‹åˆ›å»ºå‡ ä¸ªæ–‡ä»¶å¤¹ã€‚

<Tree title="pretty.icuapi.com ç½‘ç«™çš„æ ¹ç›®å½•">
  <ul>
    <li>
      admin
      <small> æ”¾ç®¡ç†è¿è¥ç«¯ä»£ç  </small>
    </li>
    <li>
      cmsTemplates
      <small> æ”¾cmsæ¨¡æ¿ä»£ç  </small>
    </li>
    <li>
      image
      <small> å­˜æ”¾éªŒè¯ç å›¾ç‰‡ </small>
    </li>
  </ul>
</Tree>

åˆ›å»ºå®Œç«™ç‚¹åéœ€è¦åˆ›å»ºæ•°æ®åº“å¹¶å°† `docs/db` ä¸‹é¢çš„ `.sql` æ–‡ä»¶å¯¼å…¥è¿›å»

### #0x04 å®å¡” Nginx å‚æ•°é…ç½®

```nginx
	# åç«¯æœåŠ¡è·¯å¾„
	location / {
      # è¿™é‡Œçš„ç«¯å£å· éœ€è¦å†™ä¸åç«¯é…ç½®ä¸€è‡´çš„ç«¯å£å·
      proxy_pass http://localhost:8081/;
      index  index.html;
      # ä¸‹é¢è¿™å—æ˜¯ä¸ºäº†ç™»é™†æ—¥å¿—è·å–çœŸå®ip
      proxy_redirect off;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $host;
      proxy_set_header X-Real-Ip $remote_addr;
      proxy_set_header X-Ngnix-Proxy true;
    }
    # ç®¡ç†è¿è¥ç«¯é¡µé¢è·¯å¾„
    location /admin/ {
      index index.html;
      root /www/wwwroot/pretty.icuapi.com/;
      try_files  $uri $uri/  /admin/index.html;
    }

    # å›¾ç‰‡å­˜å‚¨çš„è·¯å¾„ éœ€è¦åœ¨é¡µé¢å’Œnginxå‡è¿›è¡Œé…ç½® !éæœ¬åœ°å­˜å‚¨ä¸éœ€è¦é…ç½®
    location /img/ {
      alias /www/wwwroot/pretty.icuapi.com/;
      index index.html index.htm;
    }

	# æ‹¦æˆªH5ç«¯é¡µé¢
    location / {
      try_files $uri $uri/ /index.html last;
      index index.html;
    }
```

å®Œæ•´çš„ Nginx æ–‡ä»¶(åŸºäºå®å¡”ç¯å¢ƒ)

### #0x05 ç¼–å†™ç®€æ˜“å¯åŠ¨è„šæœ¬

è¾“å…¥å‘½ä»¤å¯åŠ¨åç«¯æœåŠ¡ç¨‹åº

```shell
nohup java -jar castle-fortress-admin.jar --spring.profiles.active=prod > record.log &
```

ç¬¬ä¸€æ¬¡ç”¨ä¸Šé¢ ğŸ‘† çš„å‘½ä»¤è¿›è¡Œå¯åŠ¨ï¼Œä»¥åç›´æ¥å°†ä¸‹é¢çš„ä»£ç ä¿®æ”¹ä¿å­˜ï¼Œæ‰§è¡Œå³å¯ã€‚

```shell
vim run.sh
```

å°†ä¸‹é¢çš„æ–‡ä»¶å¤åˆ¶è¿›å»

```shell
#!/bin/bash
if [ -s castle-fortress-admin.jar ]; then
ps -ef | grep open.jar | grep -v grep | awk '{print $2}'| xargs kill -9
rm open.jar
mv castle-fortress-admin.jar open.jar
nohup java -jar open.jar --spring.profiles.active=prod > record.log &
tail -f record.log
else
    echo "æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·ä¸Šä¼ ååœ¨æ‰§è¡Œï¼"
fi
```

> psï¼šåªéœ€è¦å°†ä¸Šé¢ä»£ç ä¸­çš„ open.jar ä¿®æ”¹ä¸ºä½ å–œæ¬¢çš„åå­—å³å¯ã€‚
>
> vim ä¿å­˜å‘½ä»¤ä¸ºï¼š:wqï¼ˆæ³¨æ„æ˜¯æŒ‰ esc ä¹‹åçš„è¾“å…¥å†’å· wqï¼‰

### #0x06 æ·»åŠ  SSL è¯ä¹¦

![æ·»åŠ SSLè¯ä¹¦](https://oss.icuapi.com/docs/openapi/%E6%B7%BB%E5%8A%A0ssl%E8%AF%81%E4%B9%A6.png)

SSL è¯ä¹¦é€šè¿‡[è…¾è®¯äº‘](https://cloud.tencent.com/product/ssl)å’Œ[é˜¿é‡Œäº‘](https://www.aliyun.com/product/cas)å‡å¯è¿›è¡Œç”³è¯·ï¼Œæ¯ä¸ªè´¦å·èƒ½å…è´¹ç”³è¯· 20 å¼ ã€‚ç”³è¯·ä¹‹åä¸‹è½½ nginx ç‰ˆæœ¬çš„ï¼Œå°†å¯¹åº”çš„ä¿¡æ¯å¤åˆ¶è¿›å»å³å¯ã€‚
